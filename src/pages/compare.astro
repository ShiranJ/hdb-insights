---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import '../styles/tools.css';

const title = 'Compare HDB Prices | HDB Insights';
const description = 'Compare HDB resale prices across different estates, flat types, and time periods. Get real-time data from Singapore government APIs.';
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={title} description={description} />
		<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
	</head>
	<body>
		<Header />
		<main class="tool-container dashboard-layout">
			<div class="dashboard-sidebar glass-panel">
				<div class="sidebar-header">
					<h2>Filters <span id="selection-count" class="badge">1/4</span></h2>
					<button class="btn btn-secondary" id="refresh-btn" title="Refresh data from server">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
							<path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
							<path d="M21 3v5h-5"></path>
							<path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
							<path d="M3 21v-5h5"></path>
						</svg>
					</button>
				</div>
				
				<!-- Filter Group -->
				<div class="filter-section">
					<label>Estates to Compare</label>
					<div class="estate-selectors">
						<select id="town1"><option value="">Select Estate</option></select>
						<select id="town2"><option value="">Select Estate 2 (Optional)</option></select>
						<select id="town3"><option value="">Select Estate 3 (Optional)</option></select>
						<select id="town4"><option value="">Select Estate 4 (Optional)</option></select>
					</div>
				</div>

				<div class="filter-section">
					<label for="flat-type">Flat Type</label>
					<select id="flat-type">
						<option value="4 ROOM">4 Room</option>
						<option value="3 ROOM">3 Room</option>
						<option value="5 ROOM">5 Room</option>
						<option value="EXECUTIVE">Executive</option>
						<option value="2 ROOM">2 Room</option>
					</select>
				</div>

				<div class="filter-section">
					<label for="time-range">Time Range</label>
					<select id="time-range">
						<option value="1Y">1 Year</option>
						<option value="6M">6 Months</option>
						<option value="3M">3 Months</option>
						<option value="3Y">3 Years</option>
						<option value="5Y">5 Years</option>
					</select>
				</div>

				<!-- Advanced Filters in details -->
				<details class="advanced-filters-compact">
					<summary>Advanced Filters</summary>
					<div class="advanced-grid">
						<div class="filter-item">
							<label for="storey">Storey</label>
							<select id="storey">
								<option value="">Any</option>
								<option value="01 TO 03">01-03</option>
								<option value="04 TO 06">04-06</option>
								<option value="07 TO 09">07-09</option>
								<option value="10 TO 12">10-12</option>
								<option value="13 TO 15">13-15</option>
								<option value="16 TO 18">16-18</option>
								<option value="19 TO 21">19-21</option>
								<option value="22 TO 24">22-24</option>
								<option value="25 TO 27">25-27</option>
								<option value="28 TO 30">28-30</option>
								<option value="31 TO 33">31-33</option>
								<option value="34 TO 36">34-36</option>
								<option value="37 TO 39">37-39</option>
								<option value="40 TO 42">40-42</option>
							</select>
						</div>
						<div class="filter-item">
							<label>Min Lease</label>
							<input type="number" id="min-lease" placeholder="Years">
						</div>
						<div class="filter-item">
							<label>Area (Min)</label>
							<input type="number" id="min-area" placeholder="Sqm">
						</div>
						<div class="filter-item">
							<label>Area (Max)</label>
							<input type="number" id="max-area" placeholder="Sqm">
						</div>
					</div>
				</details>

				<button class="btn btn-primary w-full mt-4" id="compare-btn">
					<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
						<line x1="18" y1="20" x2="18" y2="10"></line>
						<line x1="12" y1="20" x2="12" y2="4"></line>
						<line x1="6" y1="20" x2="6" y2="14"></line>
					</svg>Compare Prices
				</button>
			</div>

			<div class="dashboard-main">
				<div class="tool-header">
					<h1>
						<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 12px; color: var(--hdb-teal);">
							<path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
							<polyline points="9 22 9 12 15 12 15 22"></polyline>
						</svg>HDB Price Comparison
					</h1>
					<p>Compare resale prices across different estates and flat types</p>
				</div>

				<div class="sync-status-bar">
					<div id="sync-badge" class="badge badge-success" style="display: none;">
						<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;">
							<path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
						</svg><span id="new-count">0</span> new transactions
					</div>
					<div id="last-updated" class="status-pill" style="display: none;">
						<span class="status-dot"></span>
						Last Updated: <span id="updated-time">-</span>
					</div>
				</div>

			<!-- Loading State -->
			<div id="loading-state" style="display: none;">
				<div class="cards-grid">
					<div class="comparison-card">
						<div class="loading-skeleton" style="height: 200px;"></div>
					</div>
					<div class="comparison-card">
						<div class="loading-skeleton" style="height: 200px;"></div>
					</div>
				</div>
			</div>

			<!-- Empty State -->
			<div id="empty-state" class="empty-state">
				<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
				</svg>
				<h3>Select estates to compare</h3>
				<p>Choose at least one estate and click "Compare" to see price data</p>
			</div>

			<!-- Comparison Cards -->
			<div id="cards-container" class="cards-grid" style="display: none;"></div>

			<!-- Chart Section -->
			<div id="chart-section" class="chart-container" style="display: none; margin-top: 2rem;">
				<div class="chart-header">
					<h3 class="chart-title">Price Trends Over Time</h3>
					<div class="chart-controls">
						<button data-metric="median_price" class="active">Median Price</button>
						<button data-metric="avg_price">Avg Price</button>
						<button data-metric="transaction_count">Volume</button>
						<button id="download-png" class="btn btn-secondary" style="margin-left: 0.5rem; padding: 0.2rem 0.6rem; font-size: 0.75rem;">
							ðŸ“· PNG
						</button>
						<button id="share-link" class="btn btn-secondary" style="margin-left: 0.5rem; padding: 0.2rem 0.6rem; font-size: 0.75rem;">
							ðŸ”— Share
						</button>
					</div>
				</div>
				<div style="height: 400px; position: relative; width: 100%;">
					<canvas id="price-chart"></canvas>
				</div>
			</div>

			<!-- Data Table -->
			<div id="table-section" style="display: none; margin-top: 2rem;">
				<div class="chart-container">
					<div class="chart-header">
						<h3 class="chart-title">Detailed Statistics</h3>
						<button class="btn btn-secondary" id="export-csv" style="display: flex; align-items: center; gap: 8px; padding: 0.5rem 1rem;">
							<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
								<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
								<polyline points="7 10 12 15 17 10"></polyline>
								<line x1="12" y1="15" x2="12" y2="3"></line>
							</svg>Export CSV
						</button>
					</div>
					<div style="overflow-x: auto;">
						<table id="data-table" style="width: 100%; border-collapse: collapse;">
							<thead id="table-head"></thead>
							<tbody id="table-body"></tbody>
						</table>
					</div>
				</div>
			</div>
				</div>
			</div>
		</main>

		<style is:global>
			.dashboard-layout {
				display: grid;
				grid-template-columns: 320px 1fr;
				gap: 2rem;
				max-width: 1600px;
				margin: 0 auto;
				padding: 2rem;
			}
			.dashboard-sidebar {
				display: flex;
				flex-direction: column;
				gap: 1.5rem;
				padding: 2rem;
				height: fit-content;
				position: sticky;
				top: 6.5rem;
				transition: var(--hdb-transition-fast);
			}
			.sidebar-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 0.5rem;
			}
			.sidebar-header h2 {
				display: flex;
				align-items: center;
				gap: 0.75rem;
				font-size: 1.25rem;
			}
			#selection-count {
				background: var(--hdb-teal);
				color: white;
				font-size: 0.75rem;
				padding: 0.2rem 0.6rem;
				border-radius: 99px;
			}
			.sync-status-bar {
				display: flex;
				align-items: center;
				gap: 1rem;
				margin-bottom: 2rem;
			}
			.status-pill {
				display: inline-flex;
				align-items: center;
				gap: 0.5rem;
				padding: 0.4rem 0.8rem;
				background: var(--hdb-teal);
				background: rgba(0, 109, 119, 0.1);
				color: var(--hdb-teal);
				border-radius: 99px;
				font-size: 0.75rem;
				font-weight: 700;
				border: 1px solid rgba(0, 109, 119, 0.2);
			}
			.status-dot {
				width: 6px;
				height: 6px;
				background: var(--hdb-teal);
				border-radius: 50%;
				animation: pulse 2s infinite;
			}
			@keyframes pulse {
				0% { opacity: 1; }
				50% { opacity: 0.4; }
				100% { opacity: 1; }
			}
			.estate-selectors {
				display: flex;
				flex-direction: column;
				gap: 0.75rem;
			}
			select, input {
				appearance: none;
				padding: 0.875rem 1.25rem;
				background: var(--hdb-bg-elevated);
				border: 1.5px solid var(--hdb-border);
				border-radius: 14px;
				color: var(--hdb-text);
				font-size: 0.9375rem;
				width: 100%;
				transition: all var(--hdb-transition-fast);
				cursor: pointer;
				background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23006D77' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
				background-repeat: no-repeat;
				background-position: right 1rem center;
				background-size: 1.2rem;
				padding-right: 2.5rem;
			}
			input { background-image: none; padding-right: 1.25rem; }
			select option {
				background-color: var(--hdb-bg-elevated);
				color: var(--hdb-text);
				padding: 1rem;
			}
			select:hover, input:hover {
				border-color: var(--hdb-teal);
				background-color: var(--hdb-glass-bg);
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
			}
			select:focus, input:focus {
				outline: none;
				border-color: var(--hdb-teal);
				box-shadow: 0 0 0 4px rgba(0, 109, 119, 0.15);
				transform: translateY(-2px);
			}
			.advanced-filters-compact {
				margin: 1rem 0;
				border-top: 1px solid var(--hdb-border);
				padding-top: 0.5rem;
			}
			.advanced-filters-compact summary {
				font-size: 0.875rem;
				font-weight: 700;
				color: var(--hdb-teal);
				cursor: pointer;
				padding: 0.5rem 0;
				user-select: none;
				transition: var(--hdb-transition-fast);
				list-style: none;
				display: flex;
				align-items: center;
				gap: 0.5rem;
			}
			.advanced-filters-compact summary::-webkit-details-marker { display: none; }
			.advanced-filters-compact summary::before {
				content: '';
				display: inline-block;
				width: 0;
				height: 0;
				border-left: 5px solid transparent;
				border-right: 5px solid transparent;
				border-top: 6px solid var(--hdb-teal);
				transition: transform 0.2s;
			}
			.advanced-filters-compact[open] summary::before {
				transform: rotate(-180deg);
			}
			.advanced-grid {
				display: grid;
				grid-template-columns: 1fr;
				gap: 1.25rem;
				padding: 1.25rem 0;
			}
			.filter-item {
				display: flex;
				flex-direction: column;
				gap: 0.5rem;
			}
			.filter-item label {
				font-size: 0.75rem;
				font-weight: 700;
				color: var(--hdb-text-muted);
				text-transform: uppercase;
			}
			.stat-grid-dashboard {
				display: grid;
				grid-template-columns: repeat(2, 1fr);
				gap: 1rem;
				margin-top: 1.25rem;
				padding-top: 1.25rem;
				border-top: 1px solid var(--hdb-border);
			}
			.stat-item-compact {
				display: flex;
				flex-direction: column;
				gap: 0.25rem;
			}
			.stat-item-compact .stat-label {
				font-size: 0.75rem;
				font-weight: 600;
				color: var(--hdb-text-muted);
				text-transform: uppercase;
				letter-spacing: 0.025em;
			}
			.stat-item-compact .stat-value-sm {
				font-size: 0.9375rem;
				font-weight: 700;
				color: var(--hdb-text);
			}
			.card-footer-info {
				margin-top: 1rem;
				font-size: 0.8125rem;
				color: var(--hdb-text-muted);
				text-align: right;
			}
			.card-footer-info strong {
				color: var(--hdb-teal);
			}
			.trend-icon {
				font-size: 1.1em;
				font-weight: 900;
				margin-right: 2px;
			}
			@media (max-width: 1024px) {
				.dashboard-layout {
					grid-template-columns: 1fr;
					padding: 1rem;
					gap: 1.5rem;
				}
				.dashboard-sidebar {
					position: static;
					padding: 1.5rem;
				}
				.dashboard-sidebar h2 { font-size: 1.125rem; }
				.tool-header h1 { font-size: 1.5rem !important; }
				.tool-header p { font-size: 0.875rem; }
				.stat-grid-dashboard {
					gap: 0.75rem;
					margin-top: 1rem;
					padding-top: 1rem;
				}
				.stat-value-sm { font-size: 0.8125rem !important; }
			}
			@media (max-width: 640px) {
				.chart-header {
					flex-direction: column;
					align-items: flex-start;
					gap: 1rem;
				}
				.chart-controls {
					width: 100%;
					overflow-x: auto;
					padding-bottom: 0.5rem;
				}
				.estate-selectors { gap: 0.5rem; }
				select, input { padding: 0.75rem 1rem; font-size: 0.875rem; }
			}
		</style>
		<Footer />

		<div class="toast-container" id="toast-container"></div>

		<script is:inline>
			const HDB_TOWNS = [
				'ANG MO KIO', 'BEDOK', 'BISHAN', 'BUKIT BATOK', 'BUKIT MERAH',
				'BUKIT PANJANG', 'BUKIT TIMAH', 'CENTRAL AREA', 'CHOA CHU KANG',
				'CLEMENTI', 'GEYLANG', 'HOUGANG', 'JURONG EAST', 'JURONG WEST',
				'KALLANG/WHAMPOA', 'MARINE PARADE', 'PASIR RIS', 'PUNGGOL',
				'QUEENSTOWN', 'SEMBAWANG', 'SENGKANG', 'SERANGOON', 'TAMPINES',
				'TOA PAYOH', 'WOODLANDS', 'YISHUN'
			];

			let priceChart = null;
			let comparisonData = [];
			let currentMetric = 'median_price';

			function showToast(message, type = 'success') {
				const container = document.getElementById('toast-container');
				const toast = document.createElement('div');
				toast.className = `toast toast-${type}`;
				toast.innerHTML = `
					<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
						<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
						<polyline points="22 4 12 14.01 9 11.01"></polyline>
					</svg>
					<span>${message}</span>
				`;
				container.appendChild(toast);
				
				// Force reflow
				toast.offsetHeight;
				toast.classList.add('show');
				
				setTimeout(() => {
					toast.classList.remove('show');
					setTimeout(() => toast.remove(), 400);
				}, 3000);
			}

			// Initialize town dropdowns
			function initDropdowns() {
				const selects = ['town1', 'town2', 'town3', 'town4'];
				selects.forEach((id, idx) => {
					const select = document.getElementById(id);
					HDB_TOWNS.forEach(town => {
						const option = document.createElement('option');
						option.value = town;
						option.textContent = town.split(' ').map(w => 
							w.charAt(0) + w.slice(1).toLowerCase()
						).join(' ');
						select.appendChild(option);
					});
					// Set default values if not current in URL
					const params = new URLSearchParams(window.location.search);
					if (!params.has(id)) {
						if (idx === 0) select.value = 'ANG MO KIO';
						if (idx === 1) select.value = 'BEDOK';
					}
				});
			}

			// Update selection counter
			function updateSelectionCount() {
				const selectors = ['town1', 'town2', 'town3', 'town4'];
				const count = selectors.filter(id => document.getElementById(id).value).length;
				document.getElementById('selection-count').textContent = `${count}/4`;
			}

			// Fetch comparison data
			async function fetchComparison(town, flatType, range, filters = {}) {
				const params = new URLSearchParams({ 
					town, flat_type: flatType, range,
					...filters
				});
				const response = await fetch(`/api/comparison?${params}`);
				if (!response.ok) throw new Error('Failed to fetch data');
				return await response.json(); // Return full wrapper key { data: ..., cached_at: ... }
			}

			// Format currency
			function formatCurrency(value) {
				return new Intl.NumberFormat('en-SG', {
					style: 'currency',
					currency: 'SGD',
					maximumFractionDigits: 0
				}).format(value);
			}

			// Create comparison card
			function createCard(data, town) {
				const latest = data.data[0] || {};
				const oldest = data.data[data.data.length - 1] || {};
				
				// Calculate overall period change (oldest in range to latest)
				const periodChange = oldest.median_price 
					? Math.round(((latest.median_price - oldest.median_price) / oldest.median_price * 100) * 10) / 10
					: 0;

				return `
					<div class="comparison-card glass-panel">
						<div class="card-header">
							<span class="card-title">${town.split(' ').map(w => w.charAt(0) + w.slice(1).toLowerCase()).join(' ')}</span>
							<span class="card-badge">${data.flat_type}</span>
						</div>
						<div class="card-stats">
							<div class="stat-group main-stat">
								<div class="stat-label">Median Price</div>
								<div class="stat-value highlight">${formatCurrency(latest.median_price || 0)}</div>
							</div>
							
							<div class="stat-grid-dashboard" style="grid-template-columns: repeat(2, 1fr); margin-bottom: 1rem;">
								<div class="stat-item-compact">
									<div class="stat-label">MoM Trend</div>
									<div class="stat-value-sm" style="color: ${latest.mom_pct >= 0 ? '#22c55e' : '#ef4444'};">
										${latest.mom_pct ? (latest.mom_pct > 0 ? 'â†‘' : 'â†“') + ' ' + Math.abs(latest.mom_pct) + '%' : '-%'}
									</div>
								</div>
								<div class="stat-item-compact">
									<div class="stat-label">YoY Trend</div>
									<div class="stat-value-sm" style="color: ${latest.yoy_pct >= 0 ? '#22c55e' : '#ef4444'};">
										${latest.yoy_pct ? (latest.yoy_pct > 0 ? 'â†‘' : 'â†“') + ' ' + Math.abs(latest.yoy_pct) + '%' : '-%'}
									</div>
								</div>
							</div>

							<div class="stat-grid-dashboard">
								<div class="stat-item-compact">
									<div class="stat-label">Volume</div>
									<div class="stat-value-sm">${latest.transaction_count || 0}</div>
								</div>
								<div class="stat-item-compact">
									<div class="stat-label">Avg $/Sqm</div>
									<div class="stat-value-sm">${formatCurrency(latest.avg_price_psm || 0)}</div>
								</div>
								<div class="stat-item-compact">
									<div class="stat-label">Min Price</div>
									<div class="stat-value-sm">${formatCurrency(latest.min_price || 0)}</div>
								</div>
								<div class="stat-item-compact">
									<div class="stat-label">Max Price</div>
									<div class="stat-value-sm">${formatCurrency(latest.max_price || 0)}</div>
								</div>
							</div>
							<div class="card-footer-info" style="display: flex; justify-content: space-between; align-items: center;">
								<span>Avg Lease: <strong>${latest.avg_lease || '-'} yrs</strong></span>
								<span style="font-size: 0.75rem; font-weight: 700; color: ${periodChange >= 0 ? '#22c55e' : '#ef4444'};">
									Range: ${periodChange > 0 ? 'â†‘' : 'â†“'} ${Math.abs(periodChange)}%
								</span>
							</div>
						</div>
					</div>
				`;
			}

			// Update chart
			function updateChart() {
				const ctx = document.getElementById('price-chart');
				
				if (priceChart) {
					priceChart.destroy();
				}

				const datasets = comparisonData.map((item, idx) => {
					const colors = ['#2563eb', '#0891b2', '#8b5cf6', '#22c55e'];
					return {
						label: item.town,
						data: item.data.data.data.slice().reverse().map(d => d[currentMetric]),
						borderColor: colors[idx % colors.length],
						backgroundColor: colors[idx % colors.length] + '20',
						tension: 0.3,
						fill: true
					};
				});

				// Get labels from first dataset
				const labels = comparisonData[0]?.data.data.data.slice().reverse().map(d => d.month) || [];

				priceChart = new Chart(ctx, {
					type: 'line',
					data: { labels, datasets },
					options: {
						responsive: true,
						maintainAspectRatio: false,
						interaction: {
							mode: 'index',
							intersect: false,
						},
						plugins: {
							legend: { 
								position: 'top',
								labels: {
									usePointStyle: true,
									padding: 20,
									font: { size: 12, weight: 600 }
								}
							},
							tooltip: {
								backgroundColor: 'rgba(0, 0, 0, 0.8)',
								padding: 12,
								titleFont: { size: 14, weight: 700 },
								bodyFont: { size: 13 },
								callbacks: {
									label: function(context) {
										const label = context.dataset.label || '';
										const value = context.raw;
										if (currentMetric === 'transaction_count') {
											return `${label}: ${value} units`;
										}
										return `${label}: ${formatCurrency(value)}`;
									}
								}
							}
						},
						scales: {
							x: {
								grid: { display: false }
							},
							y: {
								beginAtZero: false,
								grid: { color: 'rgba(0, 0, 0, 0.05)' },
								ticks: {
									callback: function(value) {
										if (currentMetric === 'transaction_count') return value;
										return '$' + (value / 1000).toFixed(0) + 'K';
									}
								}
							}
						}
					}
				});
			}

			// Generate table
			function updateTable() {
				const thead = document.getElementById('table-head');
				const tbody = document.getElementById('table-body');

				// Header
				let headerHtml = '<tr><th style="text-align: left; padding: 0.75rem; border-bottom: 2px solid var(--hdb-border);">Month</th>';
				comparisonData.forEach(item => {
					headerHtml += `
						<th style="text-align: right; padding: 0.75rem; border-bottom: 2px solid var(--hdb-border);">${item.town} Median</th>
						<th style="text-align: right; padding: 0.75rem; border-bottom: 2px solid var(--hdb-border);">${item.town} Vol</th>
					`;
				});
				headerHtml += '</tr>';
				thead.innerHTML = headerHtml;

				// Body - merge data by month
				const allMonths = new Set();
				comparisonData.forEach(item => {
					item.data.data.data.forEach(d => allMonths.add(d.month));
				});

				const sortedMonths = Array.from(allMonths).sort().reverse();
				let bodyHtml = '';

				sortedMonths.forEach(month => {
					bodyHtml += `<tr><td style="padding: 0.75rem; border-bottom: 1px solid var(--hdb-border);">${month}</td>`;
					comparisonData.forEach(item => {
						const monthData = item.data.data.data.find(d => d.month === month);
						bodyHtml += `
							<td style="text-align: right; padding: 0.75rem; border-bottom: 1px solid var(--hdb-border);">
								${monthData ? formatCurrency(monthData.median_price) : '-'}
							</td>
							<td style="text-align: right; padding: 0.75rem; border-bottom: 1px solid var(--hdb-border);">
								${monthData ? monthData.transaction_count : '-'}
							</td>
						`;
					});
					bodyHtml += '</tr>';
				});

				tbody.innerHTML = bodyHtml;
			}

			// Export to CSV
			function exportCSV() {
				if (comparisonData.length === 0) return;

				let csv = 'Month';
				comparisonData.forEach(item => {
					csv += `,${item.town} Median,${item.town} Avg,${item.town} Min,${item.town} Max,${item.town} Vol,${item.town} Lease`;
				});
				csv += '\n';

				const allMonths = new Set();
				comparisonData.forEach(item => {
					item.data.data.data.forEach(d => allMonths.add(d.month));
				});

				Array.from(allMonths).sort().reverse().forEach(month => {
					csv += month;
					comparisonData.forEach(item => {
						const d = item.data.data.data.find(x => x.month === month);
						if (d) {
							csv += `,${d.median_price},${d.avg_price},${d.min_price},${d.max_price},${d.transaction_count},${d.avg_lease || ''}`;
						} else {
							csv += ',,,,,,';
						}
					});
					csv += '\n';
				});

				const blob = new Blob([csv], { type: 'text/csv' });
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = `hdb-comparison-${new Date().toISOString().split('T')[0]}.csv`;
				a.click();
				URL.revokeObjectURL(url);
			}

			// Run comparison
			async function runComparison() {
				const town1 = document.getElementById('town1').value;
				const town2 = document.getElementById('town2').value;
				const town3 = document.getElementById('town3').value;
				const town4 = document.getElementById('town4').value;
				const flatType = document.getElementById('flat-type').value;
				const range = document.getElementById('time-range').value;

				// Collect filters
				const filters = {
					storey: document.getElementById('storey').value,
					min_area: document.getElementById('min-area').value,
					max_area: document.getElementById('max-area').value,
					min_lease: document.getElementById('min-lease').value
				};

				if (!town1) {
					alert('Please select at least one estate');
					return;
				}

				// Show loading
				document.getElementById('empty-state').style.display = 'none';
				document.getElementById('loading-state').style.display = 'block';
				document.getElementById('cards-container').style.display = 'none';
				document.getElementById('chart-section').style.display = 'none';
				document.getElementById('table-section').style.display = 'none';
				document.getElementById('last-updated').style.display = 'none';

				try {
					const towns = [town1];
					if (town2 && town2 !== town1) towns.push(town2);
					if (town3 && town3 !== town1 && town3 !== town2) towns.push(town3);
					if (town4 && town4 !== town1 && town4 !== town2 && town4 !== town3) towns.push(town4);

					comparisonData = await Promise.all(
						towns.map(async town => ({
							town,
							data: await fetchComparison(town, flatType, range, filters) // returns wrapper
						}))
					);

					// Render cards (access data.data which is ComparisonResponse)
					const cardsHtml = comparisonData.map(item => createCard(item.data.data, item.town)).join('');
					document.getElementById('cards-container').innerHTML = cardsHtml;

					// Display Last Updated
					if (comparisonData[0] && comparisonData[0].data.cached_at) {
						const dateStr = new Date(comparisonData[0].data.cached_at).toLocaleString();
						document.getElementById('updated-time').textContent = dateStr;
						document.getElementById('last-updated').style.display = 'block';
					}

					// Show results
					document.getElementById('loading-state').style.display = 'none';
					document.getElementById('cards-container').style.display = 'grid';
					document.getElementById('chart-section').style.display = 'block';
					document.getElementById('table-section').style.display = 'block';

					updateChart();
					updateTable();
				} catch (error) {
					console.error('Error:', error);
					document.getElementById('loading-state').style.display = 'none';
					document.getElementById('empty-state').style.display = 'block';
					document.getElementById('empty-state').querySelector('h3').textContent = 'Error loading data';
					document.getElementById('empty-state').querySelector('p').textContent = 'Please try again later. The database may not have data yet.';
				}
			}

			// Fetch sync status for freshness badge
			async function checkSyncStatus() {
				try {
					const res = await fetch('/api/sync-status');
					if (!res.ok) return;
					const data = await res.json();
					
					if (data.last_sync_at) {
						// Format relative time
						const lastSync = new Date(data.last_sync_at);
						const diffHrs = Math.round((new Date() - lastSync) / (1000 * 60 * 60));
						document.getElementById('updated-time').textContent = diffHrs === 0 ? 'Just now' : `${diffHrs}h ago`;
						document.getElementById('last-updated').style.display = 'flex';
						
						if (data.records_processed > 0) {
							document.getElementById('new-count').textContent = data.records_processed;
							document.getElementById('sync-badge').style.display = 'flex';
						} else {
							document.getElementById('sync-badge').style.display = 'none';
						}
					}
				} catch (e) {
					console.warn('Could not fetch sync status');
				}
			}

			// Sync filters with URL
			function syncURL() {
				const params = new URLSearchParams();
				const fields = ['town1', 'town2', 'town3', 'town4', 'flat-type', 'time-range', 'storey', 'min-area', 'max-area', 'min-lease'];
				fields.forEach(f => {
					const el = document.getElementById(f);
					const val = el?.value;
					if (val) params.set(f, val);
				});
				window.history.replaceState({}, '', `${window.location.pathname}?${params.toString()}`);
			}

			// Load filters from URL
			function loadFromURL() {
				const params = new URLSearchParams(window.location.search);
				let hasParams = false;
				params.forEach((val, key) => {
					const el = document.getElementById(key);
					if (el) {
						el.value = val;
						hasParams = true;
					}
				});
				if (hasParams) runComparison();
			}

			// Initialize
			document.addEventListener('DOMContentLoaded', () => {
				initDropdowns();
				loadFromURL();
				checkSyncStatus();
				updateSelectionCount();

				// Listen for selection changes
				['town1', 'town2', 'town3', 'town4'].forEach(id => {
					document.getElementById(id).addEventListener('change', updateSelectionCount);
				});
				
				document.getElementById('compare-btn').addEventListener('click', () => {
					runComparison();
					syncURL();
				});
				
				document.getElementById('refresh-btn').addEventListener('click', async () => {
					if (!confirm('Sync data from Government API? This takes ~30s.')) return;
					
					const btn = document.getElementById('refresh-btn');
					btn.disabled = true;
					showToast('Starting manual data sync...', 'info');
					
					try {
						const response = await fetch('/api/cron?secret=manual-sync-trigger');
						const data = await response.json();
						if (data.success) {
							showToast(`Sync complete! ${data.records_inserted} new units found.`, 'success');
							checkSyncStatus();
							runComparison();
						} else {
							showToast('Sync failed: ' + (data.error || 'Check server logs'), 'error');
						}
					} catch (e) {
						showToast('Connection error: ' + e.message, 'error');
					} finally {
						btn.disabled = false;
					}
				});

				document.getElementById('export-csv').addEventListener('click', exportCSV);
				
				document.getElementById('download-png').addEventListener('click', () => {
					const canvas = document.getElementById('price-chart');
					const link = document.createElement('a');
					link.download = `hdb-price-trend-${new Date().toISOString().split('T')[0]}.png`;
					link.href = canvas.toDataURL('image/png');
					link.click();
					showToast('Chart exported as PNG');
				});

				document.getElementById('share-link').addEventListener('click', () => {
					syncURL(); // Ensure URL is up to date
					navigator.clipboard.writeText(window.location.href);
					showToast('Comparison link copied to clipboard!');
				});

				// Chart metric controls
				document.querySelectorAll('.chart-controls button[data-metric]').forEach(btn => {
					btn.addEventListener('click', () => {
						document.querySelectorAll('.chart-controls button').forEach(b => b.classList.remove('active'));
						btn.classList.add('active');
						currentMetric = btn.dataset.metric;
						updateChart();
					});
				});
			});
		</script>
	</body>
</html>
